<!DOCTYPE html>  <html> <head>   <title>dnsserver.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               dnsserver.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">),</span>
    <span class="nx">Buffer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;buffer&#39;</span><span class="p">).</span><span class="nx">Buffer</span><span class="p">,</span>
    <span class="nx">dgram</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;dgram&#39;</span><span class="p">),</span>
    <span class="nx">riak</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;riak/riak-node&#39;</span><span class="p">),</span>
    <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">DnsServer</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">DnsServer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>define dependencies</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">ee</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">riak</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>todo add TCP support</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="nx">dgram</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">(</span><span class="s1">&#39;udp4&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>Events in DNS server </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">msgRecv</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>set event handlers for internals</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="s1">&#39;msgRecv&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">);</span> 

        <span class="nx">req</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">createRequest</span><span class="p">();</span> 
        <span class="nx">req</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span>
    <span class="p">});</span>
    
    <span class="k">this</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;postMsgProcess&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">createResponse</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;postResProcess&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">server</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sent</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">callEventStack</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">pos</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">insertAt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tail</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">pos</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">tail</span><span class="p">);</span>
    <span class="p">};</span> 

    <span class="kd">var</span> <span class="nx">stack</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span> 

    <span class="k">if</span> <span class="p">(</span><span class="nx">pos</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">stack</span> <span class="o">=</span> <span class="nx">insertAt</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">pos</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">callEventStack</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">//Event being called</span>
    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">//DnsServer</span>
    <span class="kd">var</span> <span class="nx">thar</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="c1">//Context of call</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">self</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">Propegation</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">self</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">Propegation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
           <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">][</span><span class="nx">i</span><span class="p">];</span> 
        <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">thar</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">Propegation</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">preventDefault</span> <span class="o">!==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_defaultCallback</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">thar</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">].</span><span class="nx">preventDefault</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defaultCallback</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defaultCallback</span><span class="p">.</span><span class="nx">msgRecv</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
    <span class="nx">self</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    
    <span class="nx">self</span><span class="p">.</span><span class="nx">processPacket</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
<span class="p">};</span> 

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processPacket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">rinfo</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">rinfo</span> <span class="o">=</span> <span class="nx">rinfo</span><span class="p">;</span>
   
    <span class="k">this</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;preMsgProcess&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">rinfo</span><span class="p">);</span> 
    </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <p>split up the message into the dns request header info and the query</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">processRequest</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">q</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">ee</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;postMsgProcess&#39;</span><span class="p">,</span> <span class="nx">q</span><span class="p">);</span>

<span class="p">};</span>
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>slices a single byte into bits
assuming only single bytes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_sliceBits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">off</span><span class="p">,</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="nx">off</span> <span class="o">+</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

    <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">&gt;&gt;&gt;</span> <span class="nx">s</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">b</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="nx">len</span><span class="p">);</span>

<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>takes a buffer as a request</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <p>see rfc1035 for more details
http://tools.ietf.org/html/rfc1035#section-4.1.1</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>TODO write code to break questions up into an array</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">question</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="nx">tmpSlice</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">tmpByte</span><span class="p">;</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-11">#</a>               </div>               <p>transaction id
2 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-12">#</a>               </div>               <p>slice out a byte for the next section to dice into binary.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tmpSlice</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-13">#</a>               </div>               <p>convert the binary buf into a string and then pull the char code
for the byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tmpByte</span> <span class="o">=</span> <span class="nx">tmpSlice</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-14">#</a>               </div>               <p>qr
1 bit</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">qr</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-15">#</a>               </div>               <p>opcode
0 = standard, 1 = inverse, 2 = server status, 3-15 reserved
4 bits</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">opcode</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-16">#</a>               </div>               <p>authorative answer
1 bit</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">aa</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-17">#</a>               </div>               <p>truncated
1 bit</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">tc</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-18">#</a>               </div>               <p>recursion desired
1 bit</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">rd</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-19">#</a>               </div>               <p>slice out a byte to dice into binary</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tmpSlice</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-20">#</a>               </div>               <p>convert the binary buf into a string and then pull the char code
for the byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">tmpByte</span> <span class="o">=</span> <span class="nx">tmpSlice</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-21">#</a>               </div>               <p>recursion available
1 bit</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">ra</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-22">#</a>               </div>               <p>reserved 3 bits
rfc says always 0</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-23">#</a>               </div>               <p>response code
0 = no error, 1 = format error, 2 = server failure
3 = name error, 4 = not implemented, 5 = refused
6-15 reserved
4 bits</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">rcode</span> <span class="o">=</span> <span class="nx">sliceBits</span><span class="p">(</span><span class="nx">tmpByte</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-24">#</a>               </div>               <p>question count
2 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">qdcount</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-25">#</a>               </div>               <p>answer count
2 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">ancount</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-26">#</a>               </div>               <p>ns count
2 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">nscount</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-27">#</a>               </div>               <p>addition resources count
2 bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">arcount</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-28">#</a>               </div>               <p>assuming one question
qname is the sequence of domain labels
qname length is not fixed however it is 4
octets from the end of the buffer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qname</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-29">#</a>               </div>               <p>qtype</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qtype</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-30">#</a>               </div>               <p>qclass</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">query</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qclass</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">query</span><span class="p">;</span>
<span class="p">};</span>


<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createResponse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/*</span>
<span class="cm">    * Step 1: find record associated with query</span>
<span class="cm">    */</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">findRecords</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qname</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">    * Step 2: construct response object</span>
<span class="cm">    */</span>

    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-31">#</a>               </div>               <p>1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span> <span class="c1">//same as query id</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-32">#</a>               </div>               <p>combined 1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">qr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//this is a response</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//standard for now TODO: add other types 4-bit!</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">aa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//authority... TODO this should be modal</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">tc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//truncation TODO add support to indicate truncated messages</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">rd</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">rd</span><span class="p">;</span> <span class="c1">//recursion asked for</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-33">#</a>               </div>               <p>combined 1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">ra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//no rescursion here TODO add recursion in case of resolving config</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// spec says this MUST always be 0. 3bit</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">rcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//TODO add error codes 4 bit.</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-34">#</a>               </div>               <p>1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">qdcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//1 question</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-35">#</a>               </div>               <p>1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">ancount</span> <span class="o">=</span> <span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="c1">//number of rrs returned from query</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-36">#</a>               </div>               <p>1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">nscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-37">#</a>               </div>               <p>1 byte</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">arcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 

    <span class="nx">response</span><span class="p">.</span><span class="nx">question</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qname</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qname</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qtype</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qtype</span><span class="p">;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qclass</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qclass</span><span class="p">;</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span> <span class="o">=</span> <span class="nx">results</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">    * Step 3 render response into output buffer</span>
<span class="cm">    */</span>
    <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">buildResponseBuffer</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">    * Step 4 return buffer</span>
<span class="cm">    */</span>
    <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
<span class="p">};</span>
    
    
<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_domainToQname</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">domain</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
    <span class="nx">len</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">qname</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">qname</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span><span class="o">=</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">offset</span><span class="o">++</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">qname</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>
            <span class="nx">offset</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">qname</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">qname</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getZeroBuf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;}</span>
    <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">buildResponseBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-38">#</a>               </div>               <p>calculate len in octets
NB not calculating rr this is done later
headers(12) + qname(qname + 2 + 2)
e.g. 16 + 2 * qname;
qnames are Buffers so length is already in octs</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">qnameLen</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nx">qnameLen</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">getZeroBuf</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="nx">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">qr</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">opcode</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">aa</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">tc</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">rd</span><span class="p">;</span>


    <span class="nx">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">ra</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">z</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">rcode</span><span class="p">;</span>

    <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">qdcount</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">ancount</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">nscount</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">arcount</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-39">#</a>               </div>               <p>end header</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qname</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">qnameLen</span><span class="p">);</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qtype</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">12</span><span class="o">+</span><span class="nx">qnameLen</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qtype</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qclass</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">12</span><span class="o">+</span><span class="nx">qnameLen</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">qclass</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">rrStart</span> <span class="o">=</span> <span class="mi">12</span><span class="o">+</span><span class="nx">qnameLen</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-40">#</a>               </div>               <p>TODO figure out if this is actually cheaper than just iterating 
over the rr section up front and counting before creating buf</p>

<p>create a new buffer to hold the request plus the rr
len of each response is 14 bytes of stuff + qname len </p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">tmpBuf</span> <span class="o">=</span> <span class="nx">getZeroBuf</span><span class="p">(</span><span class="nx">buf</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>

        <span class="nx">buf</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">tmpBuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

        <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">tmpBuf</span><span class="p">,</span> <span class="nx">rrStart</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">tmpBuf</span><span class="p">,</span> <span class="nx">rrStart</span><span class="o">+</span><span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qtype</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">tmpBuf</span><span class="p">,</span> <span class="nx">rrStart</span><span class="o">+</span><span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qclass</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">tmpBuf</span><span class="p">,</span> <span class="nx">rrStart</span><span class="o">+</span><span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ttl</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">tmpBuf</span><span class="p">,</span> <span class="nx">rrStart</span><span class="o">+</span><span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">rdlength</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="nx">numToBuffer</span><span class="p">(</span><span class="nx">tmpBuf</span><span class="p">,</span> <span class="nx">rrStart</span><span class="o">+</span><span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">rdata</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">rdlength</span><span class="p">);</span> <span class="c1">// rdlength indicates rdata length</span>

        <span class="nx">rrStart</span> <span class="o">=</span> <span class="nx">rrStart</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">rr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>

        <span class="nx">buf</span> <span class="o">=</span> <span class="nx">tmpBuf</span><span class="p">;</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-41">#</a>               </div>               <p>TODO compression</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-42">#</a>               </div>               <p>take a number and make sure it's written to the buffer as 
the correct length of bytes with leading 0 padding where necessary
takes buffer, offset, number, length in bytes to insert</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_numToBuffer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">offset</span><span class="p">,</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">num</span> <span class="o">!=</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Num must be a number&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="nx">offset</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">offset</span><span class="o">+</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">shift</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="p">((</span><span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">));</span>

            <span class="kd">var</span> <span class="nx">insert</span> <span class="o">=</span> <span class="p">(</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="nx">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">;</span>

            <span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">insert</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">findRecords</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qname</span><span class="p">,</span> <span class="nx">qtype</span><span class="p">,</span> <span class="nx">qclass</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-43">#</a>               </div>               <p>assuming we are always going to get internet 
request but adding basic qclass support
for completeness 
TODO replace throws with error responses</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">qclass</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">qclass</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">qclass</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Only internet class records supported&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">switch</span><span class="p">(</span><span class="nx">qtype</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">;</span> <span class="c1">//a host address</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;ns&#39;</span><span class="p">;</span> <span class="c1">//an authoritative name server</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;md&#39;</span><span class="p">;</span> <span class="c1">//a mail destination (Obsolete - use MX)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;mf&#39;</span><span class="p">;</span> <span class="c1">//a mail forwarder (Obsolete - use MX)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;cname&#39;</span><span class="p">;</span> <span class="c1">//the canonical name for an alias</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;soa&#39;</span><span class="p">;</span> <span class="c1">//marks the start of a zone of authority</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;mb&#39;</span><span class="p">;</span> <span class="c1">//a mailbox domain name (EXPERIMENTAL)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">8</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;mg&#39;</span><span class="p">;</span> <span class="c1">//a mail group member (EXPERIMENTAL)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">9</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;mr&#39;</span><span class="p">;</span> <span class="c1">//a mail rename domain name (EXPERIMENTAL)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">10</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;null&#39;</span><span class="p">;</span> <span class="c1">//a null RR (EXPERIMENTAL)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">11</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;wks&#39;</span><span class="p">;</span> <span class="c1">//a well known service description</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">12</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;ptr&#39;</span><span class="p">;</span> <span class="c1">//a domain name pointer</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">13</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;hinfo&#39;</span><span class="p">;</span> <span class="c1">//host information</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">14</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;minfo&#39;</span><span class="p">;</span> <span class="c1">//mailbox or mail list information</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">15</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;mx&#39;</span><span class="p">;</span> <span class="c1">//mail exchange</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">16</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;txt&#39;</span><span class="p">;</span> <span class="c1">//text strings</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">255</span><span class="o">:</span>
            <span class="nx">qtype</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span> <span class="c1">//select all types</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No valid type specified&#39;</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">domain</span> <span class="o">=</span> <span class="nx">qnameToDomain</span><span class="p">(</span><span class="nx">qname</span><span class="p">);</span>        </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-44">#</a>               </div>               <p>TODO add support for wildcard</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">qtype</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Wildcard not support&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-45">#</a>               </div>               <p>var rr = records[domain][qclass][qtype];</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">rr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="p">}</span>



    <span class="k">return</span> <span class="nx">rr</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_qnameToDomain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">qname</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">domain</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">qname</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">qname</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-46">#</a>               </div>               <p>last char chop trailing .</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">domain</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">tmpBuf</span> <span class="o">=</span> <span class="nx">qname</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">i</span><span class="o">+</span><span class="nx">qname</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="nx">domain</span> <span class="o">+=</span> <span class="nx">tmpBuf</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">tmpBuf</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
        <span class="nx">domain</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>

        <span class="nx">i</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">qname</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">domain</span><span class="p">;</span>
<span class="p">};</span>


<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">events</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">DnsServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Started server on &#39;</span> <span class="o">+</span> <span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">createServer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">DnsServer</span><span class="p">();</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 